require 'spreadsheet'
require 'set'

LARGE_FINES = [
  "BP EXPLORATION&PRODUCTION, INC",
"BP EXPLORATION & OIL INC. (GMG290110)",
"VOLKSWAGEN OF AMERICA",
"HYUNDAI MOTOR AMERICA",
"MARSHALL (ENBRIDGE ENERGY PARTNERS)",
"ROMEOVILLE (ENBRIDGE SPILL)",
"ATP OIL & GAS CORPORATION",
"IPC (USA)",
"MASSEY ENERGY COMPANY",
"ONDO  DEEP MINE STP",
"TITANIUM METALS CORPORATION",
"DETROIT DIESEL CORPORATION",
"ADVANSIX RESINS & CHEMICALS LLC",
"SHADE CREEK PREP PLANT",
"PBS COALS, INC - JOB 10 REFUSE",
"CAMBRIA REFUSE DISPOSAL AREA",
"STAR-KIST SAMOA TUNA CANNERY",
"KIMBERLY RUN MINE",
"HORNING DEEP MINE",
"SHEEP RIDGE MINE",
"TRENT MINE",
"AGUSTUS DEEP MINE PORTAL STP",
"SCHROCK RUN MINE",
"HART MINE",
"ROX COAL GERONIMO DEEP MINE",
"PBS COALS, INC - CLEAR RUN",
"PBS COALS, INC - JOB 21",
"CAMBRIA REFUSE (SHADY HOLLOW)",
"FINZEL COAL - ROBERTS",
"ROYTOWN DEEP MINE",
"PBS COALS, INC - ACOSTA",
"TIPPLE MINE",
"SARAH MINE",
"PBS COALS, INC - JOB 12 EXPANSION",
"PBS COALS, INC - GARRETT",
"CRONER, INC - GOODTOWN PREP",
"ROX COAL - QUECREEK MINE",
"PBS COALS, INC - JOLIN",
"PBS COALS - MAGNETTO",
"CAMBRIA FUEL PREP PLANT",
"ROBERT KATULLA PROPERTY (W-2 TANK FARM)",
"TESORO ANACORTES REFINERY",
"YORKTOWN POWER STATION",
"TESORO GOLDEN EAGLE REFINERY",
"VA POWER - CHESAPEAKE",
"DOMINION CLOVER POWER STATION",
"DOMINION RESOURCES - BREMO POWER STATION",
"VIRGINIA ELECTRIC AND POWER COMPANY,  BAYARD/NORTH",
"VEPCO YORKTOWN GENERATING STATION",
"MOUNT STORM POWER STATION",
"POSSUM POINT POWER STATION",
"CHESTERFIELD POWER STATION",
"TESORO ALASKA KENAI REFINERY",
"TESORO HAWAII REFINERY",
"MOMENTIVE PERFORMANCE MATERIALS SILICONES",
"ASARCO - HAYDEN CONCENTRATOR",
"BERKSHIRE POWER PLANT",
"MOTORSCIENCE ENTERPRISE INC",
"GALVESTON BAY REFINERY",
"SAINT GOBAIN CONTAINERS INCORPORATED",
"INEOS ABS (USA) CORPORATION (1431010054)",
"POTOMAC POWER RESOURCES BENNING GENERATING STATION",
"CES ENVIRONMENTAL",
"CHESAPEAKE APPALACHIA, LLC - BUZZARD IMPOUNDMENT",
"CHESAPEAKE APPALACHIA, LLC - SKINNER WELL PAD",
"CHESAPEAKE APPALACHIA, LLC - VILLERS IMPOUNDMENT",
"FLOYD JOHNSON WELL PAD",
"CHESAPEAKE APPALACHIA, LLC - SABER WELL PAD",
"CHESAPEAKE APPALACHIA, LLC - HOHMAN PIT",
"CHESAPEAKE APPALACHIA, LLC - RALPH G LIPPS WELL PAD",
"WISCONSIN ELECTRIC POWER COMPANY, D/B/A",
"DELMAR LIGHT WELL PAD",
"CHESAPEAKE APPALACHIA, LLC - MILLER WELL PAD",
"CHESAPEAKE APPLACHIA - PLEASANT RIDGE COMPRESSOR STATION",
"CHESAPEAKE APPLACHIA, LLC - LYNN CAMP - CHESAPEAKE",
"SAMMY L STEWART ETUX 1 WELL PAD",
"WISCONSIN ELECTRIC-MARQUETTE",
"CHESAPEAKE APPALACHIA, LLC - JAMES OGDEN WELL PAD",
"OAK CREEK GENERATING STATION (SOUTH)",
"CHESAPEAKE APPALACHIA, LLC - TALL TREES",
"CHESAPEAKE APPALACHIA, LLC - RINE WELL PAD",
"CHESAPEAKE APPALACHIA, LLC (PARDEE & CURTAIN REALTY 16 WP)",
"CHESAPEAKE APPLACHIA, LLC - RAY BAKER WELL PAD",
"CHESAPEAKE APPALACHIA, LLC - GORDON STANSBERRY WELL PAD",
"CHESAPEAKE APPALACHIA, LLC - MICHAEL ROSS",
"CHESAPEAKE APPALACHIA, LLC - EDWARD GOWER WELL PAD",
"MOHLER LUMBER CO. 68 WELL PAD",
"CHESAPEAKE APPALACHIA, LLC - DURIG IMPOUNDMENT",
"CHESAPEAKE APPLACHIA, LLC - EVICK PROPERTY",
"CHESAPEAKE APPALACHIA, LLC - ELSON / TCO WELL PAD",
"CHESAPEAKE APPLACHIA",
"ATOFINA PETROCHEMICALS INCORPORATED",
"MAGELLAN PIPELINE COMPANY L.P.",
"MAGELLAN MIDSTREAM PARTNERS, L.P.",
"DUNCAN, ROBERT M.",
"MILLARD REFRIGERATED SERVICES",
"TRANS ENERGY,INC-ANDERSON SITE",
"BAILEY LONGWALL MINE",
"TRANS ENERGY, INC. - DEWHURST WELL PAD SITE",
"TRANS ENERGY, INC. - BEATY SITE",
"TRANS ENERGY, INC. - HART SITE",
"TRANS ENERGY, INC. - GOSHORN IMPOUNDMENT SITE",
"TRANS ENERGY, INC.-STOUT SITE",
"TRANS ENERGY, INC. - FREELAND SITE",
"TRANS ENERGY, INC. - LUCEY IMPOUNDMENT SITE",
"BANDIT INDUSTRIES INC",
"TRANS ENERGY, INC. - SHAVER SITE",
"TRANS ENERGY, INC. - SIVERT SITE",
"TRANS ENERGY, INC. - BLACKSHERE SITE",
"TRANS ENERGY, INC. - BATSON SITE",
"TRANS ENERGY, INC. - JONES SITE",
"TRANS ENERGY",
"BLANCHARD TERMINAL COMPANY - JACKSONVILLE TERMINAL",
"BIG SANDY KY ASPHALT",
"BLANCHARD REFINING GALVESTON BAY REFINERY",
"BLANCHARD TERMINAL COMPANY â CHARLOTTE",
"MPLX TERMINALS, LLC - TAMPA TERMINAL",
"TONAWANDA COKE CORP",
"HUSQVARNA N.A. PRODUCT DEVELOPMENT CENTER",
"U S STEEL GREAT LAKES WORKS",
"YUENGLING BREWERY",
"YUENGLING BREWERY (501 MAHANTONGO ST)",
"CECO-J H CAMPBELL POWER PLT",
"BC COBB GENERATING PLANT",
"D E KARN & J C WEADOCK GENERATING PLANTS",
"MONROE INVESTMENTS I LLC",
"EMD MILLIPORE CORP",
"LEHIGH SOUTHWEST CEMENT COMPANY",
"DOS RIOS WATER RECYCLING CENTER",
"LEON CREEK WATER RECYCLING CENTER",
"MITCHELL LAKE WWTF",
"MEDIO CREEK WATER RECYC. CTR.",
"SALADO CREEK WWTP",
"ELEMENTIS CHROMIUM, LP",
"DEER PARK TERMINAL",
"ARKLA WASTE DISPOSAL SERVICES",
"MOBIL CHEMICAL COMPANY BCSP",
"CCS MIDSTREAM SERVICES LLC",
"SEVERSTAL WHEELING INC - FOLLANSBEE",
"EXIDE TECHNOLOGIES FRISCO RECYCLING CENTER",
"GATEWAY ENERGY & COKE CO LLC",
"DTE SPARROWS POINT",
"CITIGAS",
"R FINKLESTEIN-880 GARRISON AVE",
"FENN WELL PAD SITE",
"XTO ENERGY - GOULD SITE",
"CITYGAS CORP",
"CITIGAS SERVICE STATION",
"145-15 ROCKAWAY BLVD PETROLEUM",
"ROUTE 295 TRUCK STOP",
"SERVICE STATION",
"CITYGAS-LEGGETT",
"LIBERTY GAS (A.K.A. CITIGAS 2509)",
"WINDOES WELL PAD SITE",
"XTO ENERGY",
"NORTHWEST HARDWOODS, INC. - FRAMETOWN SAW MILL",
"XTO ENERGY - CRIM SITE",
"GFD GASOLINE INC PROPERTY",
"XTO ENERGY - MCCLELLAND SITE",
"XTO ENERGY, INC. - FANCHER SITE",
"ROCKAWAY SERVICE SVTATION INC",
"COOPER MOBIL S/S INC",
"ARCELORMITTAL MONESSEN COKE PLANT",
"LONDON WATER TUNNEL",
"KING PHARMACEUTICALS",
"WHOLE FOODS MARKET",
"GALLO GLASS CO",
"US SUZUKI MOTOR CORP",
"HARRELL'S LLC",
"STATE LINE ENERGY LLC",
"DOMINION KINCAID GENERATION LLC",
"HAVERHILL COKE CO LLC",
"PATRIOT MINING CO, INC (LITTLE INDIAN CREEK ROAD)",
"OCCIDENTAL OF ELK HILLS INC (FORMER NAVAL PETROLEUM RESERVE)",
"CHARLOTTE AMALIE WTP",
"GEORGE SIMMONDS POTW",
"DONOE WWTP",
"MANGROVE LAGOON",
"RED POINT WASTEWATER TREATMENT FACILITY",
"ST CROIX ANGUILLA WWTP",
"NEW TUTU WWTP",
"BRASSVIEW ESTATES POTW",
"VESSUP BAY WTP",
"NEW CRUZ BAY WWTP",
"BORDEAUX POTW",
"E.I DUPONT DE NEMOURS AND COMPANY",
"PIKEWOOD GOLF COURSE",
"T-RICK INDUSTRIES",
"AK STEEL CORP",
"CONEY ISLAND WATER POLLUTION CONTROL PLANT",
"ATI ALBANY OPERATIONS",
"B & W RESOURCES INC (860-7020)",
"SUPERIOR CRUDE GATHERING",
"PEACE INDUSTRY GROUP (USA)",
"E I DUPONT DE NEMOURS - YERKES PLANT",
"CALGON CARBON COPORATION - BIG SANDY PLT",
"WESTVACO CORP  BERYL",
"EXIDE TECHNOLOGIES",
"ENTERPRISE MINING CO LLC (860-5280)",
"B & W RESOURCES INC (860-0546)",
"KINCAID ENTERPRISES INC (848-0232)",
"ENTERPRISE MINING",
"ENTERPRISE MINING CO LLC (867-0444)",
"DIAMOND MAY COAL",
"DIAMOND MAY COAL CO (860-0374)",
"ENTERPRISE MINING CO LLC (867-0445)",
"VIRGINIA ENERGY CO (898-0565)",
"PREMIER ELKHORN COAL CO INC (898-5694)",
"DIAMOND MAY COAL CO (860-0406)",
"ENTERPRISE MINING CO LLC (867-5283)",
"ENTERPRISE MINING CO LLC (867-5275)",
"ENTERPRISE MINING CO LLC",
"ENTERPRISE MINING CO LLC (867-5269)",
"ENTERPRISE MINING CO",
"LOGAN GAP DEVELOPMENT CO INC (860-0432)",
"DIAMOND MAY COAL CO (860-5223)",
"ENTERPRISE MINING CO LLC (867-5278)",
"DIAMOND MAY COAL CO (860-5238 & 860-5285)",
"ENTERPRISE MINING CO LLC (867-5270)",
"B & W RESOURCES INC (860-0549)",
"FORMER GULF 487",
"FORMER GULF STATION 445",
"FORMER GULF 435 / LA COLECTIVA SERVICE STATION",
"FORMER GULF 395 / TOTAL SERVICE STATION 29",
"PUMA (FORMER GULF 425)",
"FORMER GULF 435",
"FORMER GULF STATION 316",
"FORMER GULF",
"FORMER GULF 301",
"EUREKA GAS STATION 7 (FORMER GULF 404)",
"FORMER GULF 406",
"FORMER GULF STATION 452",
"FORMER GULF STATION 459",
"FORMER GULF 424",
"EAST BANK WASTEWATER TREATMENT PLANT",
"FORMER GULF 805",
"FORMER GULF 362 / JUNIOR SERVICE STATION",
"FORMER GULF STATION 478",
"FORMER GULF 429",
"RG STEEL SPARROWS POINT LLC",
"FORMER GULF 468 / TOPMART",
"PUMA ENERGY CARIBE (FORM CARIB PET REF)",
"FORMER GULF 495",
"FORMER GULF 461 / PUMA",
"FORMER GULF 342",
"FORMER GULF STATION 408",
"FORMER GULF STATION 415",
"BIG ELK MINING CO LLC (860-0421)",
"FORMER GULF 482 / PUMA",
"FORMER GULF 496",
"FORMER GULF 905",
"GULF 56",
"FORMER GULF 400 (TOTAL PETROLEUM)",
"FOUR CORNERS STEAM ELECTRIC STATION",
"FORMER GULF STATION 300",
"GARAGE GULF RULLAN (FORMER GULF 376)",
"FORMER GULF 356",
"FORMER GULF 430",
"EAST BAY MUD MAIN WWTP",
"LAFARGE MIDWEST INC",
"LAFARGE MIDWEST INC JOPPA PLANT",
"WASHINGTON SUBURBAN SANITARY COMMMISION",
"BOSWELL ENERGY CENTER",
"SURACI METAL FINISHING LLC",
"TACONITE HARBOR ENERGY CENTER",
"LASKIN ENERGY CENTER",
"ARCHER DANIELS MIDLAND CO",
"INNOPHOS INC - INNOPHOS GEISMAR PLANT",
"ADM",
"ADM - RED WING",
"ARCHER DANIELS MIDLAND",
"ANADARKO GALVESTON SHORE BASE",
"ANADARKO-GC 608A(MARCO POLO)",
"BOOMVANG SPAR, EAST BREAKS 643 PLATFORM",
"CONSTITUTION SPAR, GREEN CANYON 680 PLATFORM",
"GUNNISON SPAR, GARDEN BANKS 668 PLATFORM ;A;",
"LUCIUS SPAR, KEATHLEY CANYON 875 PLATFORM",
"NANSEN SPAR, EAST BREAKS 602 PLATFORM ;A;",
"INDEPENDENCE MISSISSIPPI CANYON 920",
"EAGLE US 2 LLC - LAKE CHARLES COMPLEX",
"ADM QUINCY",
"ADM GRAIN CO",
"ADM ALLIANCE NUTRITION INC",
"AK STEEL DEARBORN WORKS",
"SHINTECH INC",
"ATLANTIC TRADING & MARKETING, INC.",
"WILHELMSEN SHIPS SERVICE",
"CHEMOURS - BELLE PLANT",
"ALBANY WET WEATHER BYPASS",
"PIEDMONT SEWER COLLECTION SYSTEM",
"EMERYVILLE SEWER COLLECTION SYSTEM",
"OAKLAND SEWER COLLECTION SYSTEM",
"STEGE SEWER COLLECTION SYSTEM",
"ALAMEDA SEWER COLLECTION SYSTEM",
"JONWAY MOTORCYCLE USA",
"PDC - FRENCH 1, 5; 41-4; SITZMAN 1; 32-4",
"PDC - FIELDS 11-34/ FIELDS NELSON 34-1/.",
"PDC BOHLENDER 1, 43-20",
"PDC BINDER 22, 32-10DU & 10OU, CDU, K...",
"PDC HETTINGER 1; 33, 44-18",
"PDC MAROSTICA PAD",
"PDC ENERGY - FOOS",
"PDC - JOHNSON 14, 24-4",
"PETROLEUM DEV WASTE SERVICES 21-35",
"PDC GATEWOOD 3, 6-1",
"PDC - KOEHLER 1, 2",
"NAVAJO REFINING CO",
"CLEAN HARBORS EL DORADO LLC",
"AMAZON SERVICES LLC",
"HOLLY REFINING & MARKETING CO WOODS CROSS REFINERY",
"INDIANAPOLIS BELMONT WWTP",
"PULLIAM POWER PLANT",
"TOGNUM AMERICA",
"HOLLYFRONTIER CORPORATION",
"HONOLULU HARBOR",
"NYC'S CROTON WATER SUPPLY SYSTEM",
"CEMEX INC DEMOPOLIS PLANT",
"KOSMOS CEMENT CO",
"CEMEX CONSTRUCTION MATERIALS ATLANTIC - KNOXVILLE PLANT",
"NEBRASKA BY PRODUCTS",
"CHEMSOLV INC",
"SHENANGO LLC",
"FMC CORP AGRIPRODUCTS GROUP",
"INDIANAPOLIS - SOUTHPORT WWTP",
"TERVITA LLC",
"ADM SOYBEAN PROCESSING",
"ADM CORN PROCESSING",
"ADM SOYBEAN PROCESSING PLANT",
"BARTON SOLVENTS INC DES MOINES",
"TESORO PETROLEUM COMPANIES, INC",
"IPL - M.L. KAPP GENERATING STATION",
"DUBUQUE POWER PLANT",
"TESORO MANDAN REFINERY",
"BURLINGTON GENERATING STATION",
"TESORO ALASKA KENAI PIPELINE FACILITY",
"IPL - SIXTH STREET GENERATING STATION",
"EMPIRE ABO GAS PLANT/COMPRESSOR STATION",
"MICHELIN POWERHOUSE (EX MICHELIN FACILITY)",
"BASF FINA PETROCHEMICALS",
"LAHEY HITCHCOCK MEDICAL CENTER",
"MOTIVA ENTERPRISES LLC NORCO REFINERY",
"CABOT CORP",
"DICKERSON GENERATING STATION",
"KERN OIL & REFINING CO",
"LIMA REFINING CO",
"PHILADELPHIA ENERGY SOLUTIONS R&M LLC",
"UNIVERSAL PRESSURE PUMPING",
"UNIVERSAL PRESSURE PUMPING MIDLAND YARD",
"H&S PERFORMANCE, LLC",
"LIBERTY MANAGEMENT LLC (836-0454)",
"BRAWLEY WASTEWATER TREATMENT PLANT",
"MATHESON TRI-GAS",
"FRASURE CREEK MINING LLC (898-0715)",
"LIBERTY MANAGEMENT LLC (836-0456)",
"CLIFFSIDE STEAM STATION",
"ENTERPRISE MONT BELVIEU COMPLEX",
"CABOT CANAL PLANT SPECIALTY CARBONS",
"CABOT CORP VILLE PLATTE PLANT",
"DUKE POWER - DAN RIVER STEAM STATION",
"BUCK STEAM STATION",
"DAIRYLAND POWER COOP GENOA POWER PLANT",
"DAIRYLAND POWER",
"DAIRYLAND POWER CO-OP J P MADGETT",
"GRIFFIN PIPE PRODUCTS COMPANY",
"YAMAHA MOTOR CORP USA",
"MOTIVA ENTERPRISES CONVENT REFINERY",
"VINTAGE PETROLEUM, INC",
"DAYTON POWER & LIGHT CO JM STUART STATION",
"US ECOLOGY",
"HRSD - ATLANTIC SEWAGE TREATMENT PLANT",
"LIBERTY PETROLEUM (S & B PETROLEUM)",
"TAG GASOLINE",
"RACHEL PETROLEUM INC.",
"PDE ISLAND PARK",
"ACUITY SPECIALTY PRODUCTS GROUP, INC.",
"MOTIVA ENTERPRISES LLC, MERIDIAN TERMINAL",
"MOTIVA",
"CHAHEL ENTERPRISES DBA VIENNA SHELL",
"HRSD",
"SHELL CHEMICAL LP",
"HARCROS CHEMICALS, INC.",
"LION OIL CO",
"CEMEX",
"CEMEX CONSTRUCTION MATERIALS SOUTH LLC",
"LOWE'S HOME CENTER",
]

namespace :categorize_by_misc do

  # looks for facilities without a naics code, but with a sic code
  # that starts with "9"
  task gov_sic: :environment do
    set = Set.new
    counter = 0

    fac_with_sic_codes = File.join(Rails.root.join("lib", "tasks", "files", "gov_with_sic.xls"))
    workbook = Spreadsheet.open(fac_with_sic_codes)
    sheet = workbook.worksheet(0)

    sheet.each do |item|
      set.add(item[0].to_i)
    end

    Facility.pluck(:registry_id).each do |id|
      if set.include?(id)
        f = Facility.find_by_registry_id(id)
        f.fac_type = "gov"
        f.save
        counter += 1
      end
    end

    puts "#{counter} facilities marked as 'gov' type."
  end

  task count_gov_words: :environment do
    counter = Hash.new(0)

    Facility.where(fac_type: 'gov').pluck(:fac_name).each do |name|
      words = name.split(" ")
      words.each { |word| counter[word] += 1 }
    end

    puts counter.sort_by { |k, v| -v }[0..750].map { |pair| "'#{pair.first}'," }
  end

  task count_gov_2_words: :environment do
    counter = Hash.new(0)

    Facility.where(fac_type: 'gov').pluck(:fac_name).each do |name|
      words = name.split(" ").each_cons(2).map { |word| word.join(" ") }
      words.each { |word| counter[word] += 1 }
    end

    puts counter.sort_by { |k, v| -v }[0..1000].map { |pair| "'#{pair.first}'," }
  end

  task count_3_words: :environment do
    counter = Hash.new(0)

    Facility.where(fac_type: 'gov').pluck(:fac_name).each do |name|
      words = name.split(" ").each_cons(3).map { |word| word.join(" ") }
      words.each { |word| counter[word] += 1 }
    end

    puts counter.sort_by { |k, v| -v }[0..200].map { |pair| "'#{pair.first}'," }
  end

  task large_fines: :environment do
    counter = 0

    LARGE_FINES.each do |company|
      Facility.where('fac_name LIKE ?', "#{company}%").each do |large|
        large.fac_type = 'large'
        large.save
        puts large.fac_name
        counter += 1
      end
    end

    puts "#{counter} facilities marked as large."
  end
end
